Submitted By: Joe Ciccone <jciccone@linuxfromscratch.org>
Date: 2006-11-09
Initial Package Version: 2.5
Origin: Joe Ciccone
Upstream Status: Unknown
Description: Checks to see if libgcc_eh has been provided by gcc. If it has
             the glibc will attempt to link to it.

             Rediffed for 2.9 by Brett Neumeier
             Rediffed for 2.10.1 by Brett Neumeier
             Rediffed for 2.11 by Brett Neumeier
             Rediffed for 2.12 by Brett Neumeier
             Rediffed for 2.12.2 by Brett Neumeier
             Rediffed for 2.14.1 by Brett Neumeier
             Rediffed for 2.15 by Brett Neumeier
             Rediffed for 2.16 by Brett Neumeier

---
 Makeconfig     |    6 +++++-
 config.make.in |    1 +
 configure      |   28 ++++++++++++++++++++++++++++
 configure.in   |   19 +++++++++++++++++++
 4 files changed, 53 insertions(+), 1 deletions(-)

diff --git a/Makeconfig b/Makeconfig
index 417fa50..06f24e5 100644
--- a/Makeconfig
+++ b/Makeconfig
@@ -523,7 +523,11 @@ else
 endif
 libgcc_eh := -Wl,--as-needed -lgcc_s $(libunwind) -Wl,--no-as-needed
 gnulib := -lgcc $(libgcc_eh)
-static-gnulib := -lgcc -lgcc_eh $(libunwind)
+ifneq ($(have-cc-with-libgcc_eh),yes)
+ static-gnulib := -lgcc $(libunwind)
+else
+ static-gnulib := -lgcc -lgcc_eh $(libunwind)
+endif
 libc.so-gnulib := -lgcc
 endif
 +preinit = $(addprefix $(csu-objpfx),crti.o)
diff --git a/config.make.in b/config.make.in
index 65410ab..764e5f0 100644
--- a/config.make.in
+++ b/config.make.in
@@ -65,6 +65,7 @@ have-selinux = @have_selinux@
 have-libaudit = @have_libaudit@
 have-libcap = @have_libcap@
 have-cc-with-libunwind = @libc_cv_cc_with_libunwind@
+have-cc-with-libgcc_eh = @libc_cv_cc_with_libgcc_eh@
 fno-unit-at-a-time = @fno_unit_at_a_time@
 bind-now = @bindnow@
 have-hash-style = @libc_cv_hashstyle@
diff --git a/configure b/configure
index aa7869f..40b621b 100755
--- a/configure
+++ b/configure
@@ -617,6 +617,7 @@ libc_cv_z_execstack
 libc_cv_z_combreloc
 ASFLAGS_config
 libc_cv_Bgroup
+libc_cv_cc_with_libgcc_eh
 libc_cv_cc_with_libunwind
 VERSIONING
 BISON
@@ -6182,6 +6183,33 @@ if test $libc_cv_cc_with_libunwind = yes; then
 
 fi
 
+  { $as_echo "$as_me:${as_lineno-$LINENO}: checking whether to link against libgcc_eh" >&5
+$as_echo_n "checking whether to link against libgcc_eh... " >&6; }
+if ${libc_cv_cc_with_libgcc_eh+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+
+    cat > conftest.c <<EOF
+int main (void) { return 0; }
+EOF
+    if ${CC-cc} $CFLAGS $CPPFLAGS $LDFLAGS -static -o conftest \
+       conftest.c -v 2>&1 >/dev/null | grep -q " -lgcc_eh "; then
+      libc_cv_cc_with_libgcc_eh=yes
+    else
+      libc_cv_cc_with_libgcc_eh=no
+    fi
+    rm -f conftest*
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $libc_cv_cc_with_libgcc_eh" >&5
+$as_echo "$libc_cv_cc_with_libgcc_eh" >&6; }
+
+  if test $libc_cv_cc_with_libgcc_eh = yes; then
+    $as_echo "#define HAVE_CC_WITH_LIBGCC_EH 1" >>confdefs.h
+
+  fi
+
+
+
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking for -z nodelete option" >&5
 $as_echo_n "checking for -z nodelete option... " >&6; }
 if ${libc_cv_z_nodelete+:} false; then :
diff --git a/configure.in b/configure.in
index 5028e64..a4a5277 100644
--- a/configure.in
+++ b/configure.in
@@ -1416,6 +1416,25 @@ if test $libc_cv_cc_with_libunwind = yes; then
   AC_DEFINE(HAVE_CC_WITH_LIBUNWIND)
 fi
 
+  AC_CACHE_CHECK(whether to link against libgcc_eh,
+                 libc_cv_cc_with_libgcc_eh, [
+    cat > conftest.c <<EOF
+int main (void) { return 0; }
+EOF
+    if ${CC-cc} $CFLAGS $CPPFLAGS $LDFLAGS -static -o conftest \
+       conftest.c -v 2>&1 >/dev/null | grep -q " -lgcc_eh "; then
+      libc_cv_cc_with_libgcc_eh=yes
+    else
+      libc_cv_cc_with_libgcc_eh=no
+    fi
+    rm -f conftest*])
+  AC_SUBST(libc_cv_cc_with_libgcc_eh)
+  if test $libc_cv_cc_with_libgcc_eh = yes; then
+    AC_DEFINE(HAVE_CC_WITH_LIBGCC_EH)
+  fi
+
+
+
 AC_CACHE_CHECK(for -z nodelete option,
 	       libc_cv_z_nodelete, [dnl
 cat > conftest.c <<EOF
-- 
1.7.3.2

